# Production Docker Compose for Trinity Agent Platform
#
# Port allocation:
#   - 8005: Trinity backend
#   - 3005: Trinity frontend
#   - 8006: Trinity audit-logger
#   - 8007: Trinity MCP server

services:
  backend:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile
    container_name: trinity-backend
    restart: unless-stopped
    ports:
      - "8005:8005"
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-changeme}
      - AUDIT_URL=http://audit-logger:8006
      - REDIS_URL=redis://redis:6379
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - SLACK_CLIENT_ID=${SLACK_CLIENT_ID}
      - SLACK_CLIENT_SECRET=${SLACK_CLIENT_SECRET}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      - NOTION_CLIENT_ID=${NOTION_CLIENT_ID}
      - NOTION_CLIENT_SECRET=${NOTION_CLIENT_SECRET}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GITHUB_PAT=${GITHUB_PAT}
      - AUTH0_DOMAIN=${AUTH0_DOMAIN}
      - AUTH0_ALLOWED_DOMAIN=${AUTH0_ALLOWED_DOMAIN:-ability.ai}
      # Host paths for volumes (used when creating agent containers)
      # These MUST be set in your environment or deploy.config
      - HOST_TEMPLATES_PATH=${HOST_TEMPLATES_PATH}
      - HOST_META_PROMPT_PATH=${HOST_META_PROMPT_PATH}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/agent-templates:/agent-configs/templates:ro
      - ./config/trinity-meta-prompt:/trinity-meta-prompt:ro
      - agent-configs:/agent-configs
      - audit-logs:/logs
      - ${TRINITY_DATA_PATH:-./trinity-data}:/data
    depends_on:
      redis:
        condition: service_healthy
      audit-logger:
        condition: service_started
    networks:
      - trinity-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    # Production: no --reload flag
    command: uvicorn main:app --host 0.0.0.0 --port 8005 --workers 2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  frontend:
    build:
      context: ./src/frontend
      dockerfile: ../../docker/frontend/Dockerfile.prod
      args:
        - VITE_API_URL=${VITE_API_URL:-http://localhost:8005}
        - VITE_AUTH0_DOMAIN=${AUTH0_DOMAIN:-dev-10tz4lo7hcoijxav.us.auth0.com}
        - VITE_AUTH0_CLIENT_ID=${VITE_AUTH0_CLIENT_ID:-bFeIEm4WAwaalgSnxsfS1V6vd4gOk0li}
        - VITE_AUTH0_ALLOWED_DOMAIN=${AUTH0_ALLOWED_DOMAIN:-ability.ai}
    image: trinity-frontend:prod
    container_name: trinity-frontend
    restart: unless-stopped
    ports:
      - "3005:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - trinity-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETGID
      - SETUID
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:7-alpine
    container_name: trinity-redis
    restart: unless-stopped
    # Redis not exposed externally in production
    expose:
      - "6379"
    volumes:
      - redis-data:/data
    networks:
      - trinity-network
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  audit-logger:
    build:
      context: .
      dockerfile: docker/audit-logger/Dockerfile
    container_name: trinity-audit-logger
    restart: unless-stopped
    ports:
      - "8006:8006"
    volumes:
      - audit-data:/data
    networks:
      - trinity-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    environment:
      - AUDIT_DB_PATH=/data/audit.db
      - PORT=8006
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  mcp-server:
    build:
      context: ./src/mcp-server
      dockerfile: Dockerfile
    container_name: trinity-mcp-server
    restart: unless-stopped
    ports:
      - "8007:8080"
    environment:
      - NODE_ENV=production
      - MCP_PORT=8080
      - TRINITY_API_URL=http://backend:8005
      - TRINITY_USERNAME=${TRINITY_USERNAME:-admin}
      - TRINITY_PASSWORD=${ADMIN_PASSWORD:-changeme}
      - MCP_REQUIRE_API_KEY=${MCP_REQUIRE_API_KEY:-true}
      - REDIS_URL=redis://redis:6379
    depends_on:
      backend:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - trinity-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://127.0.0.1:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  agent-configs:
  redis-data:
  audit-data:
  audit-logs:
  # trinity-data: using bind mount via TRINITY_DATA_PATH env var

networks:
  trinity-network:
    driver: bridge
    name: trinity-agent-network
    ipam:
      config:
        - subnet: 172.28.0.0/16
