# Trinity Service Architecture

## Container Topology

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              DOCKER HOST                                        │
│                                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────────┐│
│  │                        PLATFORM CONTAINERS                                  ││
│  │                                                                             ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       ││
│  │  │  frontend   │  │   backend   │  │ mcp-server  │  │audit-logger │       ││
│  │  │             │  │             │  │             │  │             │       ││
│  │  │   Vue.js    │  │   FastAPI   │  │   FastMCP   │  │   FastAPI   │       ││
│  │  │   Nginx     │  │   Python    │  │   Python    │  │   Python    │       ││
│  │  │             │  │             │  │             │  │             │       ││
│  │  │  Port 3000  │  │  Port 8000  │  │  Port 8080  │  │  Port 8001  │       ││
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └─────────────┘       ││
│  │         │                │                │                                 ││
│  │         │    REST/WS     │    REST        │                                 ││
│  │         └────────────────┼────────────────┘                                 ││
│  │                          │                                                  ││
│  │  ┌─────────────┐  ┌──────┴──────┐                                          ││
│  │  │    redis    │  │   SQLite    │                                          ││
│  │  │             │  │             │                                          ││
│  │  │  Secrets    │  │  ~/trinity- │                                          ││
│  │  │  OAuth      │  │  data/      │                                          ││
│  │  │  Cache      │  │  trinity.db │                                          ││
│  │  │             │  │             │                                          ││
│  │  │  Port 6379  │  │  (bind mt)  │                                          ││
│  │  └─────────────┘  └─────────────┘                                          ││
│  │                                                                             ││
│  └────────────────────────────────────────────────────────────────────────────┘│
│                                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────────┐│
│  │                        AGENT CONTAINERS                                     ││
│  │                     Network: trinity-agent-network                          ││
│  │                        Subnet: 172.28.0.0/16                               ││
│  │                                                                             ││
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   ││
│  │  │agent-research│  │ agent-writer │  │agent-analyst │  │trinity-system│   ││
│  │  │              │  │              │  │              │  │   (SYSTEM)   │   ││
│  │  │ Claude Code  │  │ Claude Code  │  │ Claude Code  │  │ Claude Code  │   ││
│  │  │ Agent Server │  │ Agent Server │  │ Agent Server │  │ Agent Server │   ││
│  │  │ MCP Tools    │  │ MCP Tools    │  │ MCP Tools    │  │ Fleet Ops    │   ││
│  │  │              │  │              │  │              │  │              │   ││
│  │  │ :8000 (int)  │  │ :8000 (int)  │  │ :8000 (int)  │  │ :8000 (int)  │   ││
│  │  │ :2222 (SSH)  │  │ :2223 (SSH)  │  │ :2224 (SSH)  │  │ :2225 (SSH)  │   ││
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   ││
│  │                                                                             ││
│  └────────────────────────────────────────────────────────────────────────────┘│
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Backend Service Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              BACKEND (FastAPI)                                  │
│                                                                                 │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                              ROUTERS                                      │  │
│  │                                                                           │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐│  │
│  │  │  auth   │ │ agents  │ │  chat   │ │schedules│ │   git   │ │settings ││  │
│  │  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘│  │
│  │       │           │           │           │           │           │      │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐│  │
│  │  │sharing  │ │  creds  │ │templates│ │mcp_keys │ │  ops    │ │ systems ││  │
│  │  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘│  │
│  │       │           │           │           │           │           │      │  │
│  └───────┼───────────┼───────────┼───────────┼───────────┼───────────┼──────┘  │
│          │           │           │           │           │           │         │
│  ┌───────┴───────────┴───────────┴───────────┴───────────┴───────────┴──────┐  │
│  │                           SERVICES                                        │  │
│  │                                                                           │  │
│  │  ┌────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                     agent_service/                                  │  │  │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ │  │  │
│  │  │  │lifecycle │ │  crud    │ │ terminal │ │permissions│ │ folders  │ │  │  │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘ │  │  │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ │  │  │
│  │  │  │  files   │ │ metrics  │ │  queue   │ │  deploy  │ │ api_key  │ │  │  │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘ │  │  │
│  │  └────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                           │  │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐     │  │
│  │  │docker_service│ │scheduler_svc │ │  git_service │ │ audit_service│     │  │
│  │  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘     │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                           DATA LAYER                                      │  │
│  │                                                                           │  │
│  │  ┌──────────────────────────────┐  ┌──────────────────────────────────┐  │  │
│  │  │         database.py          │  │         credentials.py           │  │  │
│  │  │                              │  │                                  │  │  │
│  │  │  • Users                     │  │  • Credential storage            │  │  │
│  │  │  • Agent ownership           │  │  • OAuth tokens                  │  │  │
│  │  │  • Sharing                   │  │  • API keys                      │  │  │
│  │  │  • Permissions               │  │  • MCP configs                   │  │  │
│  │  │  • Schedules                 │  │                                  │  │  │
│  │  │  • Chat sessions             │  │         ┌─────────┐              │  │  │
│  │  │  • Activities                │  │         │  Redis  │              │  │  │
│  │  │         ┌─────────┐          │  │         └─────────┘              │  │  │
│  │  │         │ SQLite  │          │  │                                  │  │  │
│  │  │         └─────────┘          │  │                                  │  │  │
│  │  └──────────────────────────────┘  └──────────────────────────────────┘  │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## MCP Server Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           MCP SERVER (FastMCP)                                  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                         AUTHENTICATION                                     │ │
│  │                                                                            │ │
│  │   Request ──► Extract API Key ──► Validate with Backend ──► McpAuthContext│ │
│  │                                                                            │ │
│  │   Context: { userId, userEmail, keyName, agentName?, scope }              │ │
│  │                                                                            │ │
│  │   Scopes:  user (human)  │  agent (container)  │  system (trinity-system) │ │
│  │                                                                            │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                           12 MCP TOOLS                                     │ │
│  │                                                                            │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │ │
│  │  │                     AGENT MANAGEMENT                                 │  │ │
│  │  │                                                                      │  │ │
│  │  │  list_agents     get_agent      create_agent     delete_agent       │  │ │
│  │  │  start_agent     stop_agent                                          │  │ │
│  │  │                                                                      │  │ │
│  │  └─────────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                            │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │ │
│  │  │                     AGENT INTERACTION                                │  │ │
│  │  │                                                                      │  │ │
│  │  │  chat_with_agent ──► Permission Check ──► Proxy to Agent Container  │  │ │
│  │  │  get_chat_history                                                    │  │ │
│  │  │  get_agent_logs                                                      │  │ │
│  │  │                                                                      │  │ │
│  │  └─────────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                            │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │ │
│  │  │                     CONFIGURATION                                    │  │ │
│  │  │                                                                      │  │ │
│  │  │  list_templates      reload_credentials      get_credential_status  │  │ │
│  │  │                                                                      │  │ │
│  │  └─────────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                            │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```
