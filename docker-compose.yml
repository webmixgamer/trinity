services:
  backend:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile
    container_name: trinity-backend
    ports:
      - "8000:8000"
    environment:
      # SECURITY: Set these in your .env file, not here
      - SECRET_KEY=${SECRET_KEY:-}  # Required - generate with: openssl rand -hex 32
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-}  # Required - set a strong password
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - AUDIT_URL=http://audit-logger:8001
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - REDIS_URL=redis://redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}  # Optional - set for production
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}  # For Gemini-powered agents
      - GITHUB_PAT=${GITHUB_PAT:-}
      - HOST_TEMPLATES_PATH=${PWD}/config/agent-templates
      - HOST_META_PROMPT_PATH=${PWD}/config/trinity-meta-prompt
      # OpenTelemetry Configuration (Optional)
      - OTEL_ENABLED=${OTEL_ENABLED:-0}
      - OTEL_COLLECTOR_ENDPOINT=${OTEL_COLLECTOR_ENDPOINT:-http://trinity-otel-collector:4317}
      - OTEL_METRICS_EXPORTER=${OTEL_METRICS_EXPORTER:-otlp}
      - OTEL_LOGS_EXPORTER=${OTEL_LOGS_EXPORTER:-otlp}
      - OTEL_EXPORTER_OTLP_PROTOCOL=${OTEL_EXPORTER_OTLP_PROTOCOL:-grpc}
      - OTEL_METRIC_EXPORT_INTERVAL=${OTEL_METRIC_EXPORT_INTERVAL:-60000}
      # Email Service Configuration (for public link verification)
      - EMAIL_PROVIDER=${EMAIL_PROVIDER:-resend}
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - SMTP_FROM=${SMTP_FROM:-noreply@trinity.example.com}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./src/backend:/app
      - ./config/agent-templates:/agent-configs/templates:ro
      - ./config/trinity-meta-prompt:/trinity-meta-prompt:ro
      - agent-configs:/agent-configs
      - audit-logs:/logs
      - trinity-data:/data
    depends_on:
      - redis
      - audit-logger
    networks:
      - trinity-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: false
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  frontend:
    build:
      context: ./src/frontend
      dockerfile: ../../docker/frontend/Dockerfile
    image: trinity-frontend:latest
    container_name: trinity-frontend
    ports:
      - "3000:3000"
    volumes:
      - ./src/frontend:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=http://localhost:8000
      - DOCKER_ENV=true
    depends_on:
      - backend
    networks:
      - trinity-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  redis:
    image: redis:7-alpine
    container_name: trinity-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - trinity-network
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    # SECURITY: Set REDIS_PASSWORD in .env for production
    command: >
      sh -c '
        if [ -n "$REDIS_PASSWORD" ]; then
          redis-server --appendonly yes --requirepass "$REDIS_PASSWORD"
        else
          echo "WARNING: Redis running without authentication"
          redis-server --appendonly yes
        fi
      '

  audit-logger:
    build:
      context: .
      dockerfile: docker/audit-logger/Dockerfile
    container_name: trinity-audit-logger
    ports:
      - "8001:8001"
    volumes:
      - audit-data:/data
    networks:
      - trinity-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    environment:
      - AUDIT_DB_PATH=/data/audit.db

  mcp-server:
    build:
      context: ./src/mcp-server
      dockerfile: Dockerfile
    container_name: trinity-mcp-server
    ports:
      - "8080:8080"
    environment:
      - NODE_ENV=production
      - MCP_PORT=8080
      - TRINITY_API_URL=http://backend:8000
      - TRINITY_USERNAME=${TRINITY_USERNAME:-admin}
      - TRINITY_PASSWORD=${TRINITY_PASSWORD:-}  # Match ADMIN_PASSWORD in .env
      - MCP_REQUIRE_API_KEY=true
    depends_on:
      - backend
    networks:
      - trinity-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    restart: unless-stopped

  # OpenTelemetry Collector - receives metrics from Claude Code agents
  otel-collector:
    image: otel/opentelemetry-collector:0.91.0
    container_name: trinity-otel-collector
    restart: unless-stopped
    ports:
      - "4317:4317"   # gRPC receiver (OTLP)
      - "4318:4318"   # HTTP receiver (OTLP)
      - "8889:8889"   # Prometheus metrics exporter
    volumes:
      - ./config/otel-collector.yaml:/etc/otelcol/config.yaml:ro
    networks:
      - trinity-network
    labels:
      - "trinity.platform=infrastructure"
      - "trinity.service=otel-collector"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

volumes:
  agent-configs:
  redis-data:
  audit-data:
  audit-logs:
  trinity-data:

networks:
  trinity-network:
    driver: bridge
    name: trinity-agent-network
    ipam:
      config:
        - subnet: 172.28.0.0/16

