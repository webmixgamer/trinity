{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://trinity.ai/schemas/process-definition.schema.json",
  "title": "Process Definition",
  "description": "Schema for Trinity Process Definition YAML files",
  "type": "object",
  "required": ["name", "steps"],
  "properties": {
    "name": {
      "type": "string",
      "description": "Unique name for the process",
      "pattern": "^[a-z][a-z0-9-]*$",
      "minLength": 1,
      "maxLength": 64
    },
    "version": {
      "oneOf": [
        { "type": "integer", "minimum": 1 },
        { "type": "string", "pattern": "^\\d+(\\.\\d+)?$" }
      ],
      "description": "Version number (e.g., 1 or '1.0')",
      "default": 1
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of what this process does",
      "maxLength": 1000
    },
    "steps": {
      "type": "array",
      "description": "List of steps in the process",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/step"
      }
    },
    "outputs": {
      "type": "array",
      "description": "List of process outputs to capture",
      "items": {
        "$ref": "#/definitions/output"
      }
    }
  },
  "definitions": {
    "step": {
      "type": "object",
      "required": ["id", "type"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this step",
          "pattern": "^[a-z][a-z0-9_-]*$",
          "minLength": 1,
          "maxLength": 64
        },
        "name": {
          "type": "string",
          "description": "Human-readable name for this step",
          "maxLength": 128
        },
        "type": {
          "type": "string",
          "description": "Type of step",
          "enum": ["agent_task", "human_approval", "gateway", "timer", "notification"]
        },
        "depends_on": {
          "oneOf": [
            { "type": "string" },
            { "type": "array", "items": { "type": "string" } }
          ],
          "description": "Step ID(s) that must complete before this step runs"
        },
        "condition": {
          "type": "string",
          "description": "Expression that must evaluate to true for this step to run (e.g., '{{steps.review.decision}} == \"approved\"')"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "type": { "const": "agent_task" } }
          },
          "then": {
            "required": ["agent", "message"],
            "properties": {
              "agent": {
                "type": "string",
                "description": "Name of the agent to execute this task"
              },
              "message": {
                "type": "string",
                "description": "Message/prompt to send to the agent (supports {{}} templating)"
              },
              "timeout": {
                "type": "string",
                "description": "Maximum time for this step (e.g., '5m', '1h')",
                "pattern": "^\\d+(s|m|h|d)$",
                "default": "5m"
              },
              "model": {
                "type": "string",
                "description": "Optional: specific model to use"
              },
              "temperature": {
                "type": "number",
                "description": "Optional: temperature for generation",
                "minimum": 0,
                "maximum": 2
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "human_approval" } }
          },
          "then": {
            "properties": {
              "title": {
                "type": "string",
                "description": "Title shown in approval UI"
              },
              "description": {
                "type": "string",
                "description": "Description of what needs approval"
              },
              "assignees": {
                "type": "array",
                "items": { "type": "string" },
                "description": "User IDs or emails of approvers"
              },
              "timeout": {
                "type": "string",
                "description": "Maximum time to wait for approval",
                "pattern": "^\\d+(s|m|h|d)$",
                "default": "24h"
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "gateway" } }
          },
          "then": {
            "properties": {
              "gateway_type": {
                "type": "string",
                "description": "Type of gateway",
                "enum": ["exclusive", "parallel", "inclusive"],
                "default": "exclusive"
              },
              "routes": {
                "type": "array",
                "description": "Routing rules",
                "items": {
                  "type": "object",
                  "required": ["condition", "target"],
                  "properties": {
                    "condition": {
                      "type": "string",
                      "description": "Expression that determines this route"
                    },
                    "target": {
                      "type": "string",
                      "description": "Step ID to route to"
                    }
                  }
                }
              },
              "default_route": {
                "type": "string",
                "description": "Default step ID if no conditions match"
              }
            }
          }
        }
      ]
    },
    "output": {
      "type": "object",
      "required": ["source"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Name for this output",
          "default": "output"
        },
        "source": {
          "type": "string",
          "description": "Expression to extract the output value (e.g., '{{steps.final.output}}')"
        },
        "description": {
          "type": "string",
          "description": "Description of what this output contains"
        }
      }
    }
  }
}
