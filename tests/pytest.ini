[pytest]
testpaths = .
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Default options for normal runs
addopts = -v --tb=short

# Test markers for tiered execution
markers =
    smoke: Fast tests that don't require agents (~30 seconds)
    slow: Slow tests that involve actual Claude Code execution (~2 minutes each)
    requires_agent: Tests that require a running agent container
    unit: Unit tests that don't need the backend running

# Timeout per test (2 minutes default, increase for chat tests)
timeout = 120
timeout_method = signal
timeout_func_only = False

# Async mode
asyncio_mode = auto

# =============================================================================
# TEST TIERS (Use these for different scenarios)
# =============================================================================
#
# TIER 1: SMOKE TESTS (No agents, ~30 seconds)
# pytest -m smoke
# pytest --fast
#
# TIER 2: CORE TESTS (With module-scoped agents, ~3-5 minutes)
# pytest -m "not slow"
#
# TIER 3: FULL SUITE (Everything including slow chat tests, ~8-10 minutes)
# pytest
#
# =============================================================================
# PERFORMANCE NOTES (2025-12-09)
# =============================================================================
#
# Fixture scopes for agent creation:
# - created_agent: scope="module" - ONE agent per test FILE
# - stopped_agent: scope="module" - ONE stopped agent per test FILE
# - shared_agent: scope="session" - ONE agent for entire test session
# - isolated_agent: scope="function" - NEW agent per test (use sparingly!)
#
# Expected timing (single process):
# - Fast tests (auth, templates, credentials, mcp_keys): ~0.5 seconds
# - Agent module tests (lifecycle, chat, files, etc): ~45 seconds first test, <1s others
# - Full suite: ~5-8 minutes
#
# Compare to unoptimized (~60 minutes) - fixture scope="function" created
# a new agent for EVERY test, adding 30-45 seconds overhead each time.
# =============================================================================
